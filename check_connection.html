<!DOCTYPE html>
<html>

<head>
    <title>Connection Check</title>
</head>

<body>
    <h1>Backend Connection Checker</h1>
    <p>Status: <span id="status">Checking...</span></p>
    <div id="result"></div>
    <!-- Load configuration -->
    <script src="config.js"></script>
    <script>
        // Use URL parameter 'api' if present, otherwise use config, otherwise fallback
        function getApiUrl() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('api')) {
                return params.get('api');
            }
            if (typeof CONFIG !== 'undefined' && CONFIG.API_URL) {
                return CONFIG.API_URL;
            }
            return 'http://localhost:5001/'; // Fallback
        }

        const API_URL = getApiUrl();

        async function checkConnection() {
            const resultDiv = document.getElementById('result');
            const statusSpan = document.getElementById('status');

            // 1. Mixed Content Check
            const isPageHttps = window.location.protocol === 'https:';
            const isApiHttp = API_URL.startsWith('http://');

            if (isPageHttps && isApiHttp) {
                statusSpan.innerText = '‚ùå BLOCKED (Mixed Content)';
                statusSpan.style.color = 'red';
                resultDiv.innerHTML = `
                    <div style="background:#ffebee; border:1px solid red; padding:15px; border-radius:5px;">
                        <h3>üîí Security Error: Mixed Content</h3>
                        <p>You are viewing this page on <b>HTTPS</b>, but trying to connect to an <b>HTTP</b> Backend.</p>
                        <p>Browsers block this to protect you.</p>
                        <hr>
                        <h4>How to fix:</h4>
                        <ul>
                            <li><b>Option A (Best):</b> Configure Nginx/Apache to serve the Backend via SSL (HTTPS).</li>
                            <li><b>Option B (Quick Fix):</b> Load this page via HTTP instead (e.g., http://scholar.mitsgwalior.in).</li>
                            <li><b>Option C (Dev Only):</b> Click the "shield" icon in your browser URL bar and "Allow unsafe scripts/content".</li>
                        </ul>
                    </div>
                 `;
                return;
            }

            try {
                statusSpan.innerText = '‚è≥ Connecting to ' + API_URL + '...';
                const response = await fetch(API_URL); // Tries root endpoint first

                if (response.ok) {
                    const data = await response.json();
                    statusSpan.innerText = '‚úÖ CONNECTED';
                    statusSpan.style.color = 'green';
                    resultDiv.innerText = JSON.stringify(data, null, 2);
                } else {
                    statusSpan.innerText = '‚ö†Ô∏è Backend Error ' + response.status;
                    statusSpan.style.color = 'orange';
                    resultDiv.innerText = await response.text();
                }
            } catch (error) {
                statusSpan.innerText = '‚ùå CONNECTION FAILED';
                statusSpan.style.color = 'red';

                let advice = '';
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    advice = `
                        <h4>Possible Causes:</h4>
                        <ul>
                            <li><b>CORS Error:</b> The backend does not allow requests from <i>${window.location.origin}</i>. Check <code>BACKEND_CORS_ORIGINS</code> in <code>backend/.env</code>.</li>
                            <li><b>Backend Down:</b> The server component is not running or crashed.</li>
                            <li><b>Wrong URL:</b> Is <code>${API_URL}</code> correct?</li>
                            <li><b>Network:</b> Firewall blocking port 5001.</li>
                        </ul>
                    `;
                }

                resultDiv.innerHTML = `
                    <div style="background:#fff3e0; border:1px solid orange; padding:10px;">
                        <strong>Error Details:</strong> ${error.message}<br>
                        ${advice}
                    </div>
                `;
            }
        }

        checkConnection();
    </script>
</body>

</html>